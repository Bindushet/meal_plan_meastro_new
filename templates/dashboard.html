{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meal Planner Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{%static 'css/styledash.css' %}">
  <style>
    body {
      background-image: url("{% static 'img/dack-dash.jpeg' %}");
      background-size: cover;          /* Makes image cover full screen */
      background-repeat: no-repeat;    /* Prevents repeating */
      background-position: center;     /* Centers the image */
      background-attachment: fixed;    /* Makes background fixed while scrolling */
      min-height: 100vh;               /* Ensures background covers full viewport */
      margin: 0;                       /* Remove default margin */
      padding: 0;
      z-index:-1;
    }
  </style>
</head>
<body>
  <div class="app">
    <button id="sidebarToggle" class="hamburger">
      ‚ò∞
    </button>
    <!-- SIDEBAR -->
    <aside class="sidebar" style="opacity:0.9;">
      <div class="brand">
        <div class="logo">
          <img src="{%static 'img/logo.png' %}" alt="Logo" style="width:100%;height:100%;object-fit:contain;"/>
        </div>
        <div class="brand-text">
          <h1>MealPlanner</h1>
          <small>Plan ‚Ä¢ Cook ‚Ä¢ Enjoy</small>

        </div>
      </div>

      <div class="profile-card" id="profileCard">
        <!--div id="avatar" class="avatar">G</div-->
        <div class="profile-info">
          <!--button id="btnOpenProfile" class="link">Edit profile</button-->
          <!-- edit profile updated started-->
             
          <div class="dashboard-container">
            <h1>Welcome, {{ request.user.first_name|default:request.user.username }}!</h1>
            <button id="editBtn" class="btn primary"
                    style="background: linear-gradient(90deg, #00c6ff, #0072ff);color: white;padding: 10px 22px;border: none;border-radius: 10px;font-size: 15px;font-weight: 600;cursor: pointer;box-shadow: 0 4px 12px rgba(0, 150, 255, 0.4);transition: all 0.25s ease;
                    "
                    onmouseover="this.style.boxShadow='0 6px 16px rgba(0,150,255,0.6)'"
                    onmouseout="this.style.boxShadow='0 4px 12px rgba(0,150,255,0.4)'">
                Edit Profile
            </button>
            
            <div id="editProfileModal" class="modal-overlay">
            

            <!-- Profile Modal -->
            
              <div class="modal-content">
                <button id="closeBtn" class="close">&times;</button>
                <h2 style="color: black;">Edit Profile</h2>
                <form method="POST">
                  {% csrf_token %}
                  <label style="color: black;">First Name:</label>
                  <input type="text" name="first_name" value="{{ request.user.first_name }}" required>

                  <label style="color: black;">Last Name:</label>
                  <input type="text" name="last_name" value="{{ request.user.last_name }}">

                  <label style="color: black;">Email:</label>
                  <input type="email" name="email" value="{{ request.user.email }}" required>

                  <label style="color: black;">Age:</label>
                  <input type="number" name="age" value="{{ profile.age|default:'' }}">

                  <label style="color: black;">Gender:</label>
                  <select name="gender">
                    <option value="">Select</option>
                    <option value="Male" {% if profile.gender == 'Male' %}selected{% endif %}>Male</option>
                    <option value="Female" {% if profile.gender == 'Female' %}selected{% endif %}>Female</option>
                    <option value="Other" {% if profile.gender == 'Other' %}selected{% endif %}>Other</option>
                  </select>

                  <label style="color: black;">Height (cm):</label>
                  <input type="number" name="height_cm" value="{{ profile.height_cm|default:'' }}">

                  <label style="color: black;">Weight (kg):</label>
                  <input type="number" name="weight_kg" value="{{ profile.weight_kg|default:'' }}">

                  <label style="color: black;">Goal:</label>
                  <select name="goal">
                    <option value="">Select</option>
                    <option value="Weight loss" {% if profile.goal == 'Weight loss' %}selected{% endif %}>Weight loss</option>
                    <option value="Weight gain" {% if profile.goal == 'Weight gain' %}selected{% endif %}>Weight gain</option>
                    <option value="Maintenance" {% if profile.goal == 'Maintenance' %}selected{% endif %}>Maintenance</option>
                  </select>

                  <label style="color: black;">Dietary Preference:</label>
                  <select name="dietary_pref">
                    <option value="">Select</option>
                    <option value="Vegan" {% if profile.dietary_pref == 'Vegan' %}selected{% endif %}>Vegan</option>
                    <option value="Vegetarian" {% if profile.dietary_pref == 'Vegetarian' %}selected{% endif %}>Vegetarian</option>
                    <option value="Keto" {% if profile.dietary_pref == 'Keto' %}selected{% endif %}>Keto</option>
                    <option value="Paleo" {% if profile.dietary_pref == 'Paleo' %}selected{% endif %}>Paleo</option>
                    <option value="Gluten-Free" {% if profile.dietary_pref == 'Gluten-Free' %}selected{% endif %}>Gluten-Free</option>
                    <option value="Dairy-Free" {% if profile.dietary_pref == 'Dairy-Free' %}selected{% endif %}>Dairy-Free</option>
                    <option value="Pescatarian" {% if profile.dietary_pref == 'Pescatarian' %}selected{% endif %}>Pescatarian</option>
                    <option value="Low-Carb" {% if profile.dietary_pref == 'Low-Carb' %}selected{% endif %}>Low-Carb</option>
                    <option value="Low-Fat" {% if profile.dietary_pref == 'Low-Fat' %}selected{% endif %}>Low-Fat</option>
                    <option value="Nut-Free" {% if profile.dietary_pref == 'Nut-Free' %}selected{% endif %}>Nut-Free</option>
                    <option value="Soy-Free" {% if profile.dietary_pref == 'Soy-Free' %}selected{% endif %}>Soy-Free</option>
                    <option value="Halal" {% if profile.dietary_pref == 'Halal' %}selected{% endif %}>Halal</option>
                    <option value="Kosher" {% if profile.dietary_pref == 'Kosher' %}selected{% endif %}>Kosher</option>
                    <option value="None" {% if profile.dietary_pref == 'None' %}selected{% endif %}>None</option>
                  </select>

                  <label style="color: black;">Allergy Info:</label>
                  <textarea name="allergy_info">{{ profile.allergy_info|default:'' }}</textarea>

                  <div class="modal-actions">
                    <button type="submit" class="save-btn" style="background: linear-gradient(90deg,#007aff,#00e0ff);border: none;padding: 12px 22px;border-radius: 10px;font-size: 16px;color: white;cursor: pointer;-shadow: 0 4px 14px rgba(0,140,255,0.4);transition: 0.25s ease;">Save</button>
                    <button type="button" class="cancel-btn" id="'cancelBtn">Cancel</button>
                  </div>
                </form>
              </div>

            </div>
          </div>
        </div>
      </div>
      <nav class="nav">
        <button id="btnOpenGenerate" class="GenerateMealBtn" style="background:rgba(255,255,255,0.12);border:none;padding:12px;border-radius:10px;text-align:left;cursor:pointer;color:white;font-weight:600">Generate Meal</button>
        <button id="openPantry" class="openPantryBtn" style="background:rgba(255,255,255,0.12);border:none;padding:12px;border-radius:10px;text-align:left;cursor:pointer;color:white;font-weight:600">Open Pantry</button>
        <button id="btnOpenFavorites" class="nav-btn">Favorites</button>
        <button id="openDayFavBtn" class="openDayFavBtnn" style="background:rgba(255,255,255,0.12);border:none;padding:12px;border-radius:10px;text-align:left;cursor:pointer;color:white;font-weight:600;">Day Plan Favorites</button>

      </nav>
      <!-- Inside dashboard.html -->
      <form method="POST" action="{% url 'logout' %}">
        {% csrf_token %}
        <button type="submit" style="position:absolute;top:20px;right:2px;padding:6px 12px;background:#f44336;color:white;border-radius:5px;border:none;cursor:pointer;">Logout</button>
      </form>

      <div class="sidebar-footer">
        <small></small>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main" style="overflow-y: hidden;overflow-x: hidden;">
      
      {% if messages %}
        <div style="position: fixed;top: 0;left: 0;width: 100%;z-index: 9999;padding: 10px;">
          {% for message in messages %}
            <p class="msg-alert" style="width: 100%;padding: 14px 20px;margin-bottom: 8px;color: #ffffff;text-align: center;font-weight: 600;border-radius: 6px;animation: slideDown 0.4s ease-out;
                background:
                {% if message.tags == 'success' %} #16a34a
                {% elif message.tags == 'error' %} #dc2626
                {% elif message.tags == 'warning' %} #f59e0b
                {% else %} #3b82f6
                {% endif %};
                opacity: 0.6;">
              {{ message }}
            </p>
          {% endfor %}
        </div>
        {% endif %}

        <style>
        @keyframes slideDown {
            from { transform: translateY(-40px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        </style>


      <header class="topbar">
        <div>
          <h2>Welcome back, <span id="welcomeFirst">Chef</span> üëã</h2>
          <p class="muted">Quickly generate a recipe or manage what's in your pantry.</p>
        </div>

        <div class="top-actions">
          <input id="searchInput" class="search" placeholder="Search ingredients or recipes..." />
          <button id="quickGenerate" class="GenerateMealBtn">Quick Generate</button>
        </div>
      </header>

      <section class="stats">
        <div class="stat card">
          <div>
            <h3>Today's Suggestion</h3>
            <strong id="todayMeal">‚Äî</strong>
            <p class="muted">Auto-generated</p>
          </div>
        </div>

        <div class="stat card">
          <div>
            <h3>Pantry Items</h3>
            <strong id="pantryCount">{{ items|length }}</strong>
            <p class="muted">Current items</p>
          </div>
        </div>

        <div class="stat card">
          <div>
            <h3>Favorites</h3>
            <strong id="favCount">{{ favorites|length }}</strong>
            <p class="muted">Saved recipes</p>
          </div>
        </div>
      </section>

      <section class="grid">
        <article class="card wide">
          <div class="card-header">
            <h3>Generate a Meal</h3>
            <div class="muted">Pick ingredients and settings</div>
            </div>
          <div class="card-body">
        
            <div class="action-row">
              <button id="btnGenerateMeal" class="GenerateMealBtn" style="background: linear-gradient(90deg, #00c6ff, #0072ff);color: white;padding: 10px 22px;border: none;border-radius: 10px;font-size: 15px;font-weight: 600;cursor: pointer;box-shadow: 0 4px 12px rgba(0, 150, 255, 0.4);transition: all 0.25s ease;
                    "
                    onmouseover="this.style.boxShadow='0 6px 16px rgba(0,150,255,0.6)'"
                    onmouseout="this.style.boxShadow='0 4px 12px rgba(0,150,255,0.4)'">Generate Meal</button>
              <button id="btnGenerateDay" class="GenerateDayMealBtn" style="background: linear-gradient(90deg, #00c6ff, #0072ff);color: white;padding: 10px 22px;border: none;border-radius: 10px;font-size: 15px;font-weight: 600;cursor: pointer;box-shadow: 0 4px 12px rgba(0, 150, 255, 0.4);transition: all 0.25s ease;
                    "
                    onmouseover="this.style.boxShadow='0 6px 16px rgba(0,150,255,0.6)'"
                    onmouseout="this.style.boxShadow='0 4px 12px rgba(0,150,255,0.4)'" >Generate Meal for a Day</button>
              <!--button id="btnGenerateWeek" class="btn primary" style="background: linear-gradient(90deg, #00c6ff, #0072ff);color: white;padding: 10px 22px;border: none;border-radius: 10px;font-size: 15px;font-weight: 600;cursor: pointer;box-shadow: 0 4px 12px rgba(0, 150, 255, 0.4);transition: all 0.25s ease;
                    "
                    onmouseover="this.style.boxShadow='0 6px 16px rgba(0,150,255,0.6)'"
                    onmouseout="this.style.boxShadow='0 4px 12px rgba(0,150,255,0.4)'">Generate Meal for a Week</button-->
            </div>
          </div>
          <!-- DAY PLAN RESULT POPUP -->
          <div id="DayPop" aria-hidden="true"
              style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.55);backdrop-filter:blur(3px);display:{% if request.session.day_plan %}flex{% else %}none{% endif %};justify-content:center;align-items:center;z-index:999;">

              <div style="background:rgba(255,255,255,0.15);backdrop-filter:blur(18px);border-radius:16px;padding:25px 28px;width:850px;max-height:90vh;overflow-y:auto;position:relative;">
                  
                  <!-- Close Button -->
                  <button onclick="closeDayPop()"
                          style="position:absolute;top:10px;right:10px;width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,0.2);border:none;color:white;font-size:26px;cursor:pointer;">&times;</button>

                  <h3 style="font-size:24px;font-weight:700;text-align:center;color:#fff;margin-bottom:20px;">
                      üçΩÔ∏è Your AI Meal Plan for the Day
                  </h3>

                  <div id="dayPlanContainer">
                      {% with request.session.day_plan as day_plan_meals %}
                      {% if day_plan_meals %}
                          {% for meal in day_plan_meals %}
                          <div data-meal-type="{{ meal.MealType }}"
                              style="background:rgba(255,255,255,0.18);padding:16px;border-radius:12px;margin-bottom:20px;display:flex;gap:18px;color:white;">

                              <!-- Meal Image -->
                              <!--img src="{{ meal.image.url }}" 
                                  style="width:230px;height:170px;border-radius:12px;object-fit:cover;"-->

                              <!-- Meal Details -->
                              <div style="flex:1;">
                                  <h4 style="margin:0;font-size:22px;font-weight:700;">{{ meal.Name }}</h4>
                                  <p style="opacity:0.8;margin:2px 0;">üç¥ {{ meal.MealType }} ‚Ä¢ üìÖ {{ meal.day_of_week }}</p>

                                  {% if meal.ingredients_with_qty %}
                                  <p><b>Ingredients:</b></p>
                                  <ul>
                                      {% for item in meal.ingredients_with_qty %}
                                          <li>{{ item }}</li>
                                      {% endfor %}
                                  </ul>
                                  {% endif %}

                                  <strong>üë®‚Äçüç≥ Instructions:</strong>
                                  <p style="margin-top:3px;">{{ meal.RecipeInstructions_cleaned }}</p>

                                  <!-- Regenerate Button -->
                                  <form method="POST" style="margin-top:10px;">
                                      {% csrf_token %}
                                      <input type="hidden" name="action_type" value="generate_day_meal_single">
                                      <input type="hidden" name="meal_type_to_regen" value="{{ meal.MealType }}">
                                      <input type="hidden" name="selectedIngredientsday" value="{{ selected_ingredient_ids }}">
                                      <input type="hidden" name="serving_size" value="{{ serving_size }}">
                                      <button type="submit" style="background:#00e0ff;padding:8px 15px;border:none;border-radius:8px;color:black;font-weight:600;cursor:pointer;">
                                          üîÑ Regenerate {{ meal.MealType }}
                                      </button>
                                  </form>

                              </div>
                          </div>
                          {% endfor %}
                      {% else %}
                          <p style="color:white;text-align:center;">No meals generated yet.</p>
                      {% endif %}
                      {% endwith %}
                  </div>

                  <!-- Save Day Plan -->
                  <button onclick="document.getElementById('saveDayPlanForm').submit()"
                          style="width:100%;padding:13px;margin-top:20px;background:linear-gradient(90deg,#00c6ff,#0072ff);color:white;border:none;border-radius:10px;font-size:18px;cursor:pointer;">
                      ‚úÖ Save Day Plan
                  </button>

                  <form id="saveDayPlanForm" method="POST" style="display:none;">
                      {% csrf_token %}
                      <input type="hidden" name="action_type" value="save_day_plan">
                  </form>
              </div>
          </div>


          
        </article>  

        
        <aside class="card narrow"> 
          <h4>Pantry Preview</h4>
          <div id="pantryPreview" class="pantry-preview" style="max-height:260px;overflow-y:auto;padding-right:6px;scrollbar-width:none;-ms-overflow-style:none;"
                onscroll="this.querySelectorAll('::-webkit-scrollbar').forEach(el=>el.style.display='none')">
            {% if items %}
              <ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:10px;">
                {% for item in items %}
                  <li style="background:#f7f4f4;padding:10px;border-radius:8px;display:flex;align-items:center;gap:12px;">
                    {% if item.category == "Veggies" %}
                      ü•ó
                    {% elif item.category == "Dairy" %}
                      ü•õ
                    {% elif item.category == "Meat" %}
                      üçó
                    {% elif item.category == "Spices" %}
                      üßÇ
                    {% else %}
                      üçΩÔ∏è
                    {% endif %}


                    <div style="flex:1;">
                      <span style="font-size:22px;">{{ icon }}</span>
                      <strong>{{ item.ingredient_name }}</strong> ‚Äî 
                      <small>{{ item.qty }} {{ item.unit }}</small>
                    </div>

                    {% if item.expire_date and item.expire_date < today %}
                        <span style="color:red;font-weight:700;">‚ö† Expired</span>
                    {% endif %}
                  </li>
                  
                {% endfor %}
              </ul>
            {% else %}
              <p class="muted">No ingredients yet.</p>
            {% endif %}
          </div>
          <div class="mt-12">
            <button id="btnManagePantry" class="openPantryBtn" style="background: linear-gradient(90deg, #00c6ff, #0072ff);color: white;padding: 10px 22px;border: none;border-radius: 10px;font-size: 15px;font-weight: 600;cursor: pointer;-shadow: 0 4px 12px rgba(0, 150, 255, 0.4);transition: all 0.25s ease;
                    "
                    onmouseover="this.style.boxShadow='0 6px 16px rgba(0,150,255,0.6)'"
                    onmouseout="this.style.boxShadow='0 4px 12px rgba(0,150,255,0.4)'">Manage Pantry</button>
          </div>
        </aside>

        <article class="card narrow">
          <h4>Recent Recipes</h4>
            {% if user_recipes %}
            <section class="grid">
              <article class="card wide">
                <h3>üìö Your Saved Recipes</h3>
                <div style="display:flex; flex-direction:column; gap:12px; margin-top:10px;max-height:260px;overflow-y:auto;padding-right:6px;scrollbar-width:none;-ms-overflow-style:none;"
                          onscroll="this.querySelectorAll('::-webkit-scrollbar').forEach(el=>el.style.display='none')">
                  {% for r in user_recipes %}
                  <div style="background:rgb(247, 244, 244); padding:12px; border-radius:8px; display:flex; align-items:center; gap:12px;box-shadow:0 1px 4px rgba(0,0,0,0.1);">

                    {% if r.image %}
                    <img src="{{ r.image.url }}" style="width:60px; height:60px; object-fit:cover; border-radius:6px;">
                    {% else %}
                    <div style="width:60px;height:60px;background:#eee;border-radius:6px;display:flex;align-items:center;justify-content:center;">No Image</div>
                    {% endif %}

                    <div style="flex:1;">
                      <strong style="font-size:16px;">{{ r.name }}</strong><br>
                      <small style="color:#777;">{{ r.calories }} kcal</small>
                    </div>
                    
                    <button onclick="toggleFavorite('{{ r.name }}')" 
                              class="fav-btn"
                              id="favToggleBtn_{{ r.name }}"
                              style="background:none;border:none;font-size:22px;cursor:pointer;">
                          
                        {% if r.is_favorite %}
                            ‚òÖ
                        {% else %}
                            ‚òÜ
                        {% endif %}

                    </button>
                  </div>
                  {% endfor %}

                </div>
              </article>
            </section>
            {% endif %}

          <ul id="recentList" class="recent-list"></ul>
        </article>
      </section>
      
      <section style="background-color: white;padding: 20px; margin-top:20px;border-radius:5px;position:relative;">
        <article >
          <h3>Your Submitted Recipes</h3>

          {% if user_recipes %}
          <!-- LEFT BUTTON -->
          <button onclick="scrollSubmitted(-150)"
            style="position:absolute; left:0; top:50%; transform:translateY(-50%);background:black;color:white;border:none;border-radius:50%;width:32px;height:32px;cursor:pointer;opacity:0.6;z-index:5;">
            ‚Äπ
          </button>

          <!-- RIGHT BUTTON -->
          <button onclick="scrollSubmitted(150)"
            style="position:absolute; right:0; top:50%; transform:translateY(-50%);background:black;color:white;border:none;border-radius:50%;width:32px;height:32px;cursor:pointer;opacity:0.6;z-index:5;">
            ‚Ä∫
          </button>
          <div id="submittedScroll" style="display:flex; flex-direction:row; gap:20px; padding:20px;overflow-x:scroll; scrollbar-width:none;width:100%;white-space:normal;-ms-overflow-style:none;"
                onmouseover="this.querySelectorAll('::-webkit-scrollbar')">
            {% for r in user_recipes %}
            <section>
              <article style="flex:0 0 auto; width:260px; height:400px; background:white; border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.1); display:flex; flex-direction:column; padding:12px; overflow-y:auto;scrollbar-width:none;-ms-overflow-style:none;word-wrap:break-word; overflow-wrap:break-word; white-space:normal;       /* IE / Edge */
                " 
                onmouseover="this.querySelectorAll('::-webkit-scrollbar')">
                {% if r.image %}
                  <img src="{{ r.image.url }}" 
                      alt="{{ r.name }}" 
                      style="width:100%;height:160px;object-fit:cover;border-radius:6px;">
                {% else %}
                  <div style="width:100%;height:160px;background:#eee;border-radius:6px;display:flex;align-items:center;justify-content:center;">No Image</div>
                {% endif %}

                <!-- ‚úÖ Recipe name triggers preloaded popup -->
                <h4 style="cursor:pointer; color:#0072ff;" onclick="openPopup('{{ r.id }}')">
                  {{ r.name }}
                </h4>
                <p><b>Meal Type:</b> {{ r.meal_type }}</p>
                <p><b>Calories:</b> {{ r.calories }}</p>

                {% if r.ingredients %}
                  <p><b>Ingredients:</b></p>
                  <ul>
                    {% for ing, qty in r.ingredients.items %}
                      <li>{{ ing }} - {{ qty }}</li>
                    {% endfor %}
                  </ul>
                {% endif %}

                {% if r.instructions %}
                  <p><b>Instructions:</b> {{ r.instructions|truncatechars:2000 }}</p>
                {% endif %}

                {% if r.id %}
                <form action="{% url 'delete_recipe' r.id %}" method="POST" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-sm" style="background-color: #0072ff;" onclick="return confirm('Are you sure you want to delete this recipe?');">
                        Delete
                    </button>
                </form>
                {% endif %}

                <small style="color:#777">Added on {{ r.created_at|date:"M d, Y" }}</small>
                  

              </article>
            </section>

            {% endfor %}
          </div>
          {% else %}
            <p class="muted">You haven't added any recipes yet.</p>
          {% endif %}
        </article>
      </section>

      
      <section style="background-color:white; padding:20px; margin-top:20px; border-radius:5px; position:relative;">
        <article>

          <h2 style="font-size:24px; font-weight:bold; margin-bottom:20px;">Your Saved Day Plans</h2>

          {% if saved_dayplans %}

          <!-- LEFT BUTTON -->
          <button onclick="scrollDayPlans(-150)"
            style="position:absolute; left:0; top:50%; transform:translateY(-50%); background:black; color:white; border:none; border-radius:50%; width:32px; height:32px; cursor:pointer; opacity:0.6; z-index:5;">
            ‚Äπ
          </button>

          <!-- RIGHT BUTTON -->
          <button onclick="scrollDayPlans(150)"
            style="position:absolute; right:0; top:50%; transform:translateY(-50%); background:black; color:white; border:none; border-radius:50%; width:32px; height:32px; cursor:pointer; opacity:0.6; z-index:5;">
            ‚Ä∫
          </button>

          <!-- SCROLL CONTAINER -->
          <div id="dayPlanScroll"
            style="display:flex; flex-direction:row; gap:20px; padding:20px; overflow-x:scroll; scrollbar-width:none; width:100%; white-space:normal; -ms-overflow-style:none;">

            {% for plan in saved_dayplans %}
            <section style="flex:0 0 auto; width:100%; background:white; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); padding:15px;">

              

              <h3 style="text-align:center; font-size:18px; font-weight:bold; margin-bottom:15px;">
                {{ plan.date }} ({{ plan.date|date:"l" }})
              </h3>
              <!-- Favorite / Unfavorite Button -->
              <form method="POST"
                    action="{% if plan.is_favorite %}{% url 'remove_dayplan_favorite' plan.id %}{% else %}{% url 'add_dayplan_favorite' plan.id %}{% endif %}"
                    style="position:relative;  left: 1000px;">
                  
                  {% csrf_token %}
                  <button type="submit"
                      style="background:none; border:none; font-size:28px; cursor:pointer; color:gold;">
                      
                      {% if plan.is_favorite %}
                          ‚òÖ  <!-- filled star -->
                      {% else %}
                          ‚òÜ  <!-- empty star -->
                      {% endif %}
                  </button>
              </form>
              <!-- Delete -->
              <form method="POST" action="{% url 'delete_dayplan' plan.id %}">
                  {% csrf_token %}
                  <button type="submit" style="background:none; border:none; font-size:22px; cursor:pointer; color:red;position:relative;  left: 1000px;"
                          title="Delete Day Plan">üóëÔ∏è</button>
              </form>


              <!-- =============================== -->
              <div style="display:flex; gap:20px; width:100%; margin-top:20px;">

              <!-- BREAKFAST -->
              <div style="flex:1; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
                  <h2 style="margin-bottom:10px; color:#333;">ü•£ Breakfast</h2>
                  {% if plan.breakfast.image.url %}
                    <img src="{{ plan.breakfast.image.url }}" 
                        alt="{{ plan.breakfast.name }}" 
                        style="width:100%;height:160px;object-fit:cover;border-radius:6px;">
                  {% else %}
                    <div style="width:100%;height:160px;background:#eee;border-radius:6px;display:flex;align-items:center;justify-content:center;">No Image</div>
                  {% endif %}

                  <h3 style="margin:0; color:#444;">{{ plan.breakfast.name }}</h3>

                  <p style="margin:6px 0; font-size:14px; color:#777;">
                      {{ plan.breakfast.meal_type }}
                  </p>

                  <h4 style="margin-top:12px; color:#333;">Ingredients:</h4>
                  {% if plan.breakfast.ingredients %}
                  <ul style="font-size:14px; color:#555; padding-left:18px;">
                      {% for ing, qty in plan.breakfast.ingredients.items %}
                      <li>{{ ing }} - {{ qty }}</li>
                      {% endfor %}
                  </ul>
                  {% else %}
                  <p style="font-size:14px; color:#777;">No ingredients listed.</p>
                  {% endif %}

                  <h4 style="margin-top:12px; color:#333;">Instructions:</h4>
                  <p style="font-size:14px; color:#555;">{{ plan.breakfast.instructions }}</p>

                  <table border="1" cellpadding="6"
                      style="width:100%;border-collapse:collapse;margin-top:10px;background:#fafafa;">
                      <tr style="background:#e3f2fd;">
                          <th>Nutrient</th>
                          <th>Value</th>
                      </tr>
                      {% if plan.breakfast.main_nutrients %}
                          {% for key, nutrient in plan.breakfast.main_nutrients.items %}
                          <tr>
                              <td>{{ key }}</td>
                              <td>{{ nutrient }}</td>
                          </tr>
                          {% endfor %}
                      {% else %}
                          <tr><td colspan="2" style="text-align:center; color:#777;">No nutrition data</td></tr>
                      {% endif %}
                  </table>
              </div>


              <!-- LUNCH -->
              <div style="flex:1; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
                  <h2 style="margin-bottom:10px; color:#333;">üçõ Lunch</h2>
                   {% if plan.lunch.image.url %}
                    <img src="{{ plan.lunch.image.url }}" 
                        alt="{{ plan.lunch.name }}" 
                        style="width:100%;height:160px;object-fit:cover;border-radius:6px;">
                  {% else %}
                    <div style="width:100%;height:160px;background:#eee;border-radius:6px;display:flex;align-items:center;justify-content:center;">No Image</div>
                  {% endif %} 
                  <h3 style="margin:0; color:#444;">{{ plan.lunch.name }}</h3>

                  <p style="margin:6px 0; font-size:14px; color:#777;">
                      {{ plan.lunch.meal_type }}
                  </p>

                  <h4 style="margin-top:12px; color:#333;">Ingredients:</h4>
                  {% if plan.lunch.ingredients %}
                  <ul style="font-size:14px; color:#555; padding-left:18px;">
                      {% for ing, qty in plan.lunch.ingredients.items %}
                      <li>{{ ing }} - {{ qty }}</li>
                      {% endfor %}
                  </ul>
                  {% else %}
                  <p style="font-size:14px; color:#777;">No ingredients listed.</p>
                  {% endif %}
                  <h4 style="margin-top:12px; color:#333;">Instructions:</h4>
                  <p style="font-size:14px; color:#555;">{{ plan.lunch.instructions }}</p>

                  <table border="1" cellpadding="6"
                      style="width:100%;border-collapse:collapse;margin-top:10px;background:#fafafa;">
                      <tr style="background:#e3f2fd;">
                          <th>Nutrient</th>
                          <th>Value</th>
                      </tr>
                      {% if plan.lunch.main_nutrients %}
                          {% for key, nutrient in plan.lunch.main_nutrients.items %}
                          <tr>
                              <td>{{ key }}</td>
                              <td>{{ nutrient }}</td>
                          </tr>
                          {% endfor %}
                      {% else %}
                          <tr><td colspan="2" style="text-align:center; color:#777;">No nutrition data</td></tr>
                      {% endif %}
                  </table>
              </div>


              <!-- DINNER -->
              <div style="flex:1; background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
                  <h2 style="margin-bottom:10px; color:#333;">üçΩÔ∏è Dinner</h2>
                  {% if plan.dinner.image.url %}
                    <img src="{{ plan.dinner.image.url }}" 
                        alt="{{ plan.dinner.name }}" 
                        style="width:100%;height:160px;object-fit:cover;border-radius:6px;">
                  {% else %}
                    <div style="width:100%;height:160px;background:#eee;border-radius:6px;display:flex;align-items:center;justify-content:center;">No Image</div>
                  {% endif %} 
                  <h3 style="margin:0; color:#444;">{{ plan.dinner.name }}</h3>

                  <p style="margin:6px 0; font-size:14px; color:#777;">
                      {{ plan.dinner.meal_type }}
                  </p>

                  <h4 style="margin-top:12px; color:#333;">Ingredients:</h4>
                  {% if plan.dinner.ingredients %}
                  <ul style="font-size:14px; color:#555; padding-left:18px;">
                      {% for ing, qty in plan.dinner.ingredients.items %}
                      <li>{{ ing }} - {{ qty }}</li>
                      {% endfor %}
                  </ul>
                  {% else %}
                  <p style="font-size:14px; color:#777;">No ingredients listed.</p>
                  {% endif %}

                  <h4 style="margin-top:12px; color:#333;">Instructions:</h4>
                  <p style="font-size:14px; color:#555;">{{ plan.dinner.instructions }}</p>

                  <table border="1" cellpadding="6"
                      style="width:100%;border-collapse:collapse;margin-top:10px;background:#fafafa;">
                      <tr style="background:#e3f2fd;">
                          <th>Nutrient</th>
                          <th>Value</th>
                      </tr>
                      {% if plan.dinner.main_nutrients %}
                          {% for key, nutrient in plan.dinner.main_nutrients.items %}
                          <tr>
                              <td>{{ key }}</td>
                              <td>{{ nutrient }}</td>
                          </tr>
                          {% endfor %}
                      {% else %}
                          <tr><td colspan="2" style="text-align:center; color:#777;">No nutrition data</td></tr>
                      {% endif %}
                  </table>
              </div>

          

            </section>
            {% endfor %}

          </div>

          {% else %}
            <p class="muted">No meal plans saved yet.</p>
          {% endif %}
        </article>
      </section>  
      
      <footer class="footer" style="position: fixed;">
        <small class="muted">copy @ meal_plan_meastro</small>
      </footer>
    </main>
  </div>

  <div class="nutripop" id="nutripop">
    {% if user_recipes %}
    <section>
      {% for r in user_recipes %}

      <!-- Popup Container -->
      <div id="recipeModal{{ r.id }}"
          class="modal"
          style="display:none;position:fixed;top:0; left:0;width:100%; height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:9999;padding:20px;">
        <!-- Popup Box -->
        <div style="background:#ffffff;width:90%;max-width:650px;max-height:90%;overflow-y:auto;border-radius:14px;padding:25px;position:relative;box-shadow:0 4px 25px rgba(0,0,0,0.3);animation: fadeIn 0.25s ease-in-out;font-family:Arial, Helvetica, sans-serif;">

          <!-- Close Button -->
          <span onclick="closePopup('{{ r.id }}')" style="position:absolute;top:12px;right:10px;cursor:pointer;font-size:26px;font-weight:bold;color:#444;transition:0.2s;
              "
                onmouseover="this.style.color='#e63946'"
                onmouseout="this.style.color='#444'">
            √ó
        </span>
          <!-- LANGUAGE BUTTON (top-right) -->
          <div style="position:absolute; top:18px; right:18px; z-index:99999; display:flex; gap:8px; align-items:center;">
            <button id="langBtn" onclick="toggleLangBox()"
              style="padding:8px 14px; background:#4a90e2; color:#fff; border:none; border-radius:20px; cursor:pointer; font-size:14px;box-shadow:0 4px 10px rgba(0,0,0,0.15);">
              üåê Language
            </button>
            <button id="readBtn" onclick="translateThenRead()"
              style="padding:8px 14px; background:#28c76f; color:#fff; border:none; border-radius:20px; cursor:pointer; font-size:14px;box-shadow:0 4px 10px rgba(0,0,0,0.15);">
              üîä Read
            </button>
          </div>

          <!-- hidden container for Google Translate widget -->
          <div id="google_translate_element" style="display:none; position:absolute; top:60px; right:18px; z-index:99999;"></div>

          <h2 style="margin:10px 0; color:#0077cc; font-size:26px;">{{ r.name }}</h2>

          <img src="{{ r.image.url }}"
              style="width:100%;max-height:240px;object-fit:cover;border-radius:10px;margin-bottom:15px;" />

          <p><b>Meal Type:</b> {{ r.meal_type }}</p>
          <p><b>Calories:</b> {{ r.calories }}</p>

          <h4 style="margin-top:20px; color:#333;">Ingredients</h4>
          <ul style="padding-left:20px;">
            {% for ing, qty in r.ingredients.items %}
            <li>{{ ing }} - {{ qty }}</li>
            {% endfor %}
          </ul>

          <h4 style="margin-top:20px; color:#333;">Instructions</h4>
          <p style="line-height:1.5;">{{ r.instructions }}</p>

          <h4 style="margin-top:20px; color:#333;">Nutritional Info</h4>

          <table border="1" cellpadding="6"
                style="width:100%;border-collapse:collapse;margin-top:10px;background:#fafafa;">

            <tr style="background:#e3f2fd;">
              <th>Nutrient</th>
              <th>Value</th>
            </tr>

            {% if r.main_nutrients %}
                {% for key, nutrient in r.main_nutrients.items %}
                <tr>
                  <td>{{ key }}</td>
                  <td>{{ nutrient }}</td>
                </tr>
                {% endfor %}
            {% else %}
                <tr><td colspan="2" style="text-align:center; color:#777;">No nutrition data</td></tr>
            {% endif %}
          </table>

        </div>
      </div>

      {% endfor %}
    </section>
    {% endif %}
  </div>
  <!-- ===== MODALS ===== -->
  <div id="aiPopup" style="position:fixed;top:0; left:0;width:100%; height:100%; background:rgba(0,0,0,0.6);display: {{ recipe|yesno:'flex,none' }};justify-content:center;align-items:center;padding:20px;z-index:9999;">
            
    <div style="background:white;width:90%;max-width:500px;max-height:90%;overflow-y:auto;border-radius:12px;padding:20px;position:relative;box-shadow:0 6px 20px rgba(0,0,0,0.2);">

      <!-- ‚ùå Close Button -->
      <button onclick="closeAIPopup()"
              style="position:absolute;top:10px;right:10px;background:#f2f2f2;border:none;font-size:18px;padding:4px 10px;border-radius:6px;cursor:pointer;">
          ‚úñ
      </button>

      <div id="ai-meal" class="ai-meal">
        {% if recipe %}
        <section class="grid">
          <article class="card wide">
            <h3>üçΩÔ∏è AI Recommended Meals</h3>
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(390px,1fr));gap:15px;">
              
              <div style="background:white;padding:10px;border-radius:10px;">
                <!--img src="{{ r.Image_URL }}" alt="{{ r.Name }}" style="width:100%;height:160px;object-fit:cover;border-radius:6px;"-->
                <!--div>{% if recipe.Images %}
                  <img src="{{ recipe.Images.url }}" alt="{{ recipe.Name }}" style="width:100%;height:160px;object-fit:cover;border-radius:6px;">
                {% else %}
                  <div style="width:100%;height:160px;background:#eee;border-radius:6px;display:flex;align-items:center;justify-content:center;">No Image</div>
                {% endif %}</div-->
                <h4>{{ recipe.Name }}</h4>
                <p><b>Meal Type:</b> {{ recipe.MealType }}</p>
                <p><b>Calories:</b> {{ recipe.Calories }}</p>
                {% if recipe.ingredients_with_qty %}
                  <p><b>Ingredients:</b></p>
                  <ul>
                    {% for pair in recipe.ingredients_with_qty %}
                      <li>{{ pair }}</li>
                    {% endfor %}
                  </ul>
                {% endif %}

                <!-- Instructions -->
                {% if recipe.RecipeInstructions %}
                  <p><b>Instructions:</b> {{ recipe.RecipeInstructions|truncatechars:1000 }}</p>
                {% endif %}
                <small>Match Score: {{ recipe.match_score|floatformat:2 }}</small>
              </div>
            </div>
            <form method="POST" style="margin-top:15px;">
              {% csrf_token %}
              <input type="hidden" name="recipe_name" value="{{ recipe.Name }}">
              <input type="hidden" name="recipe_calories" value="{{ recipe.Calories }}">
              <input type="hidden" name="recipe_image_b64" value="{{ recipe.Images }}">
              <input type="hidden" name="recipe_instructions" value="{{ recipe.RecipeInstructions }}">
              <input type="hidden" name="recipe_ingredients" value="{{ recipe.ingredients }}">
              <input type="hidden" name="meal_type" value="{{ recipe.MealType }}">
              <button type="submit" name="submit_recipe" class="btn primary" onclick="closeAIPopup()">‚úÖ Submit</button>
              
            </form>
            <form method="POST" style="display:inline;">
              {% csrf_token %}
              <button type="submit" name="regenerate" value="1" class="btn secondary">
                üîÅ Regenerate
              </button>
            </form>
          

          </article>
        </section>
      {% endif %}
      </div>
    </div>
  </div>    

  <!-- PANTRY -->
   <div id="modalPantry" class="modal" aria-hidden="true">
    
    <div class="modal-card">
      <button id="closePantryBtn" class="modal-close" data-close="modalPantry">&times;</button> 
      <h3>Pantry Tracker</h3>

      <div class="pantry-wrap">
        <div class="left">
          <div class="pane-actions">
            <button id="btnAddItem" class="btn">+ Add Item</button>
          </div>

          <div id="pantryGrid" class="pantry-grid">
            {% for item in items %}
              <div class="pantry-card">
                <!--img src="{{ item.image.url|default:'/static/img/placeholder.png' }}" alt="{{ item.ingredient_name }}"-->
                <div class="pantry-meta">
                  <strong>{{ item.ingredient_name }}</strong>
                  <div class="muted">{{ item.qty }} {{ item.unit }} ‚Ä¢ {{ item.category }}</div>
                  {% if item.expire_date %}
                    <div class="muted">Expires: {{ item.expire_date }}</div>
                  {% endif %}
                </div>

                <div class="pantry-actions">
                  <button class="btn small editPantryBtn"
                    data-id="{{ item.id }}"
                    data-name="{{ item.ingredient_name }}"
                    data-qty="{{ item.qty }}"
                    data-unit="{{ item.unit }}"
                    data-category="{{ item.category }}"
                    data-expire="{{ item.expire_date|date:'Y-m-d' }}">
                    ‚úèÔ∏è Edit
                  </button>

                  <button class="btn small deletePantryBtn" data-id="{{ item.id }}">üóë Delete</button>
                </div>
              </div>
            {% empty %}
              <p class="muted">No pantry items yet. Add one below!</p>
            {% endfor %}
          </div>
        </div>

        <div class="right">
          <h4>Add / Edit Item</h4>
          <form method="POST" action="{% url 'dashboard' %}" enctype="multipart/form-data" id="pantryForm" class="form-stack">
            {% csrf_token %}
            <input type="hidden" name="add_pantry_item" value="1">
            {{ form.as_p }}
            <div class="row actions">
              <button class="btn primary" type="submit">Save</button>
            </div>
          </form>
        </div>
      </div>

    </div>
  </div>
  <!-- GENERATE -->
  <div class="modal" id="modalGenerate" aria-hidden="true" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.55);backdrop-filter:blur(3px);justify-content:center;align-items:center;z-index:999;">
    <div class="modal-card modal-medium modal-animate" style="background:rgba(255,255,255,0.15);backdrop-filter:blur(18px);border-radius:16px;padding:25px 28px;box-shadow:0 8px 30px rgba(0,0,0,0.35);border:1px solid rgba(255,255,255,0.25);width:500px;max-height:90vh;overflow-y:auto;animation:fadeIn 0.4s ease-out;position:relative;">
      <button class="modal-close" data-close="modalGenerate"style="background:rgba(255,255,255,0.2);border:none;font-size:26px;width:36px; height:36px;border-radius:50%;color:white;cursor:pointer;position:absolute;right:10px;top:10px;">&times;</button>

      <h3 style="font-size:24px;font-weight:700;margin-bottom:18px;text-align:center;color:#fff;">
        Generate Meal
      </h3>

      <form method="POST" id="generateMealForm" action="{% url 'dashboard' %}">
        {% csrf_token %}
        <input type="hidden" name="action_type" id="actionType" value="generate_meal">

        <!-- INGREDIENTS -->
        <div class="row" style="margin-bottom:18px;">
          <label style="font-weight:600;color:#fff;margin-bottom:6px;display:block;">
            Select Ingredients
          </label>
          <div id="warningBox" class="warning-box"
              style="display:none; margin:10px 0; padding:12px;
                      background:#ffdddd; color:#b30000; border-left:6px solid red;
                      border-radius:5px; font-weight:bold;">
          </div>

          <div id="modalIngredientsGrid" class="ingredients-grid" style="max-height:260px;overflow-y:auto;padding-right:5px;margin-top:10px;">
            
            {% for item in items %}
            <div class="ingredient-item" style="background:rgba(255,255,255,0.15);padding:10px;border-radius:10px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.2);color:white;cursor:pointer;transition:0.2s;">
              
              <label style="cursor:pointer;">
                <input type="checkbox" class="ingredient-checkbox" name="ingredients"
                      value="{{ item.id }}"
                      data-id="{{ item.id }}"
                      style="width:18px;height:18px;margin-right:10px;accent-color:#00e0ff;">
                {{ item.ingredient_name }} ({{ item.qty }} {{ item.unit }})
              </label>
              {{ item.nutrition_info|json_script:"nutrition_"|add:item.id }}

            </div>
            {% empty %}
            <p>No ingredients in pantry yet!</p>
            {% endfor %}

          </div>
        </div>

        <!-- Serving + meal type -->
        <div class="row two" style="display:flex;gap:20px;margin-bottom:18px;">
          <div style="flex:1;">
            <label style="font-weight:600;color:#fff;margin-bottom:6px;display:block;">Serving size</label>
            <input id="modalServingSize" type="number" min="1" value="2" style="width:100%;padding:10px 12px;border-radius:6px;border:none;background:rgba(255,255,255,0.8);font-size:15px;">
          </div>

          <div style="flex:1;">
            <label style="font-weight:600;color:#fff;margin-bottom:6px;display:block;">Meal type</label>
            <select name="meal_type" style="width:100%;padding:10px 12px;border-radius:6px;border:none;background:rgba(255,255,255,0.8);font-size:15px;">
              <option>Breakfast</option>
              <option>Lunch</option>
              <option>Dinner</option>
              <option>Snack</option>
            </select>
          </div>
        </div>

        <input type="hidden" name="selected_ingredients" id="selectedIngredients">

        <!-- BUTTONS -->
        <div class="row action" style="display:flex;justify-content:space-between;margin-top:10px;">
          <button class="btn primary" type="submit" id="modalGenerateBtn" 
                  onclick="openAIPopup()"
                  style="background:linear-gradient(90deg,#007aff,#00e0ff);border:none;padding:12px 22px;border-radius:10px;font-size:16px;color:white;cursor:pointer;box-shadow:0 4px 14px rgba(0,140,255,0.4);transition:0.25s ease;">
            Generate
          </button>

          <button class="btn" data-close="modalGenerate" type="button" style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);padding:12px 22px;border-radius:10px;color:#fff;font-size:16px;cursor:pointer;transition:0.25s ease;">
            Close
          </button>

        </div>
      </form>
    </div>
  </div>
  <!-- GENERATE- meal a day -->
  <div class="modal" id="modalGenerateDay" aria-hidden="true" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.55);backdrop-filter:blur(3px);justify-content:center;align-items:center;z-index:999;">  
    <div class="modal-card modal-medium modal-animate" style="background:rgba(255,255,255,0.15);backdrop-filter:blur(18px);border-radius:16px;padding:25px 28px;box-shadow:0 8px 30px rgba(0,0,0,0.35);border:1px solid rgba(255,255,255,0.25);width:500px;max-height:90vh;overflow-y:auto;animation:fadeIn 0.4s ease-out;position:relative;">
      <button class="modal-close" data-close="modalGenerateDay" style="background:rgba(255,255,255,0.2);border:none;font-size:26px;width:36px;height:36px;border-radius:50%;color:white;cursor:pointer;position:absolute;right:10px;top:10px;">&times;</button>
      <h3 style="font-size:24px;font-weight:700;margin-bottom:18px;text-align:center;color:#fff;">
        Generate Meal For A Day
      </h3>
      <form method="POST" id="generateDayMealForm" action="{% url 'dashboard' %}">
        {% csrf_token %}
        <!--input type="hidden" name="action_type" id="actionType" value="generate_day_meal"-->
        <!-- INGREDIENTS -->
        <div class="row" style="margin-bottom:18px;">
          <label style="font-weight:600;color:#fff;margin-bottom:6px;display:block;">
            Select Ingredients
          </label>
          <div id="warningBox1" class="warning-box"
              style="display:none; margin:10px 0; padding:12px;
                      background:#ffdddd; color:#b30000; border-left:6px solid red;
                      border-radius:5px; font-weight:bold;">
          </div>
          <div id="modalIngredientsGrid" class="ingredients-grid" style="max-height:260px;overflow-y:auto;padding-right:5px;margin-top:10px;">
            
            {% for item in items %}
            <div class="ingredient-item" style="background:rgba(255,255,255,0.15);padding:10px;border-radius:10px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.2);color:white;cursor:pointer;transition:0.2s;">
              
              <label style="cursor:pointer;">
                <input type="checkbox" class="ingredient-checkbox" name="ingredients"
                      value="{{ item.id }}"
                      data-id="{{ item.id }}"
                      style="width:18px;height:18px;margin-right:10px;accent-color:#00e0ff;">
                {{ item.ingredient_name }} ({{ item.qty }} {{ item.unit }})
              </label>
              {{ item.nutrition_info|json_script:"nutrition_"|add:item.id }}
            </div>
            {% empty %}
            <p>No ingredients in pantry yet!</p>
            {% endfor %}

          </div>
        </div>

         <!-- Serving + meal type -->
        <div class="row two" style="display:flex;gap:20px;margin-bottom:18px;">
          <div style="flex:1;">
            <label style="font-weight:600;color:#fff;margin-bottom:6px;display:block;">Serving size</label>
            <input name="serving_size" id="modalServingSize" type="number" min="1" value="2" style="width:100%;padding:10px 12px;border-radius:6px;border:none;background:rgba(255,255,255,0.8);font-size:15px;">
            
          </div>
        </div>
        <input type="hidden" name="selectedIngredientsday" id="selectedIngredientsday">
        <!-- BUTTONS -->
        <div class="row actions" style="display:flex;justify-content:space-between;margin-top:10px;">
          <input type="hidden" name="action_type" value="generate_day_meal">
          <button class="btn primary" type="button" id="btnSubmitGenerateDay" 
                  onclick="openDayPop()"
                  style="background:linear-gradient(90deg,#007aff,#00e0ff);border:none;padding:12px 22px;border-radius:10px;font-size:16px;color:white;cursor:pointer;box-shadow:0 4px 14px rgba(0,140,255,0.4);transition:0.25s ease;">
              Generate
          </button>

          <button class="btn" data-close="modalGenerateDay" type="button"
                  style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);padding:12px 22px;border-radius:10px;color:#fff;font-size:16px;cursor:pointer;transition:0.25s ease;">
            Close
          </button>

        </div>
      </form>

    </div>
  </div>



  <!-- FAVORITES -->
  <!-- FAVORITES (same style as Pantry) -->
  <div id="modalFavorites" class="modal-bg" aria-hidden="true" style="display:none;position:fixed;top:0; left:0;width:100vw; height:100vh;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);z-index:9999;align-items:center;justify-content:center; ">
    <div class="modal-card modal-medium modal-animate" style="background:white;border-radius:14px;padding:20px;width:90%;max-width:600px;max-height:90vh;overflow-y:auto;box-shadow:0 0 20px rgba(0,0,0,0.25);">
      <button class="modal-close" data-close="modalFavorites" style="border:none; background:none; font-size:24px; float:right; cursor:pointer;">&times;</button>
      <h3>‚≠ê Your Favorites</h3>
      <!-- Scrollable recipe list -->
      <div id="favList" style="display:flex;flex-direction:column;gap:15px;margin-top:15px;">
      
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast">
    {% if messages %}
      <div class="messages">
        {% for message in messages %}
          <p class="{{ message.tags }}">{{ message }}</p>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <!-- Recipe Modal -->
  <div id="recipeModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:9999;">
    <div style="background:white; width:80%; max-height:90%; overflow-y:auto; border-radius:10px; padding:20px; position:relative;">
      <span style="position:absolute; top:10px; right:20px; cursor:pointer; font-size:24px; font-weight:bold;" onclick="closeRecipeModal()">&times;</span>
      <div id="modalContent">
        <!-- Recipe details will be loaded here dynamically -->
      </div>
    </div>
  </div>

  <!-- DAY PLAN RESULT POPUP -->
  <div class="DayPop" id="DayPop" aria-hidden="true"
      style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.55);backdrop-filter:blur(3px);display: {% if day_plan_meals %}flex{% else %}none{% endif %};justify-content:center;align-items:center;z-index:999;">
      
    <div class="modal-card modal-large modal-animate"
        style="background:rgba(255,255,255,0.15);backdrop-filter:blur(18px);border-radius:16px;padding:25px 28px;width:850px;max-height:90vh;overflow-y:auto;position:relative;">

      <!-- Close Button -->
      <button class="modal-close" onclick="window.location.href='{% url 'clear_day_plan' %}'"
              style="background:rgba(255,255,255,0.2);border:none;font-size:26px;width:36px;height:36px;border-radius:50%;color:white;cursor:pointer;position:absolute;right:10px;top:10px;">
          &times;
      </button>

      <h3 style="font-size:24px;font-weight:700;color:#fff;text-align:center;margin-bottom:20px;">
          üçΩÔ∏è Your AI Meal Plan for the Day
      </h3>
      {% if request.session.show_day_plan %}
      <div id="dayPlanContainer">
        {% with request.session.day_plan as day_plan_meals %}
          {% if day_plan_meals %}
            {% for meal in day_plan_meals %}
            <div class="day-card"
                data-meal-type="{{ meal.MealType }}"
                style="background:rgba(255,255,255,0.18);padding:16px;border-radius:12px;margin-bottom:20px;display:flex;gap:18px;color:white;">

                <!-- LEFT: IMAGE -->
                <!--img src="{{ meal.image.url }}"
                    style="width:230px;height:170px;border-radius:12px;object-fit:cover;"-->

                <!-- RIGHT: TEXT -->
                <div style="flex:1;">
                  <h4 style="margin:0;font-size:22px;font-weight:700;">{{ meal.Name }}</h4>
                  <p style="opacity:0.8;margin:2px 0;">üç¥ {{ meal.MealType }} ‚Ä¢ üìÖ {{ meal.day_of_week }}</p>

                  {% if meal.ingredients_with_qty %}
                    <p><b>Ingredients:</b></p>
                    <ul>
                        {% for item in meal.ingredients_with_qty %}
                            <li>{{ item }}</li>
                        {% endfor %}
                    </ul>
                  {% endif %}

                  <strong>üë®‚Äçüç≥ Instructions:</strong>
                  <p style="margin-top:3px;">{{ meal.RecipeInstructions_cleaned }}</p>

                  <!-- üîÑ Regenerate button -->
                  <form method="POST" style="margin-top:10px;">
                      {% csrf_token %}
                      <input type="hidden" name="regenerate" value="1">
                      <input type="hidden" name="meal_type_to_regen" value="{{ meal.MealType }}">
                      <input type="hidden" name="selected_ingredients" value="{{ selected_ingredient_ids }}">
                      <button style="background:#00e0ff;padding:8px 15px;border:none;border-radius:8px;color:black;font-weight:600;cursor:pointer;">
                          üîÑ Regenerate {{ meal.MealType }}
                      </button>
                  </form>

                </div>
            </div>
            {% endfor %}
          {% else %}
            <p style="color:white;text-align:center;">No meals generated yet.</p>
          {% endif %}
        {% endwith %}  
      </div>
      {% endif %}
      <!-- SAVE DAY PLAN BUTTON -->
      <button id="btnSaveDayPlan" onclick="document.getElementById('saveDayPlanForm').submit()" style="width:100%;padding:13px;background:linear-gradient(90deg,#00c6ff,#0072ff);color:white;border:none;border-radius:10px;font-size:18px;margin-top:20px;cursor:pointer;">
          ‚úÖ Save Day Plan
      </button>

      <!-- Hidden Save Form -->
      <form id="saveDayPlanForm" method="POST" style="display:none;">
          {% csrf_token %}
          <input type="hidden" name="action_type" value="save_day_plan">
      </form>
    </div>
  </div>

  <!-- DAY FAVORITES POPUP -->
  <div id="modalDayFavorites" class="modal-bg" aria-hidden="true" style="display:none;position:fixed;top:0; left:0;width:100vw; height:100vh;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);z-index:1050;align-items:center;justify-content:center;">
    <div class="modal-card modal-medium modal-animate" style="background:white;border-radius:14px;padding:20px;width:90%;max-width:650px;max-height:90vh;overflow-y:auto;box-shadow:0 0 20px rgba(0,0,0,0.25);z-index:1051;">
        
        <button class="modal-close" id="closeDayFavBtn" data-close="modalDayFavorites" style="border:none; background:none; font-size:24px; float:right; cursor:pointer;">&times;</button>
        <h3 style="margin-bottom:15px;">‚ù§Ô∏è Day Plan Favorites</h3>

        <div style="display:flex; flex-direction:column; gap:15px; max-height:65vh; overflow-y:auto;">
          
          {% if day_favorites %}
              {% for plan in day_favorites %}
              <div style="border:1px solid #ddd; padding:12px; border-radius:10px;">
                  
                  <div style="display:flex; justify-content:space-between; align-items:center;">
                      <strong>{{ plan.date }} ‚Äî {{ plan.date|date:"l" }}</strong>
                      <a href="{% url 'remove_dayplan_favorite' plan.id %}" 
                        style="text-decoration:none; font-size:20px;">üíî</a>
                  </div>

                  <div style="display:flex; gap:20px; margin-top:12px;">
                      {% if plan.breakfast %}
                      <div style="width:30%; text-align:center;">
                          <img src="{{ plan.breakfast.image.url }}"
                              style="width:100%; height:120px; object-fit:cover; border-radius:10px;">
                          <p>{{ plan.breakfast.name }}</p>
                      </div>
                      {% endif %}

                      {% if plan.lunch %}
                      <div style="width:30%; text-align:center;">
                          <img src="{{ plan.lunch.image.url }}"
                              style="width:100%; height:120px; object-fit:cover; border-radius:10px;">
                          <p>{{ plan.lunch.name }}</p>
                      </div>
                      {% endif %}

                      {% if plan.dinner %}
                      <div style="width:30%; text-align:center;">
                          <img src="{{ plan.dinner.image.url }}"
                              style="width:100%; height:120px; object-fit:cover; border-radius:10px;">
                          <p>{{ plan.dinner.name }}</p>
                      </div>
                      {% endif %}
                  </div>
              </div>
              {% endfor %}
          {% else %}
              <p style="text-align:center;">No favorites added yet ‚ú®</p>
          {% endif %}

        </div>
    </div>
  </div>


  
  
  


  <script>
    
 
    document.addEventListener("DOMContentLoaded", function() {
      const editBtn = document.getElementById("editBtn");
      const editProfileModal = document.getElementById("editProfileModal");
      const closeBtn = document.getElementById("closeBtn");

      if (!editBtn || !editProfileModal || !closeBtn) {
        console.error("‚ùå Missing element: check IDs (editBtn, editProfileModal, closeBtn)");
        return;
      }

      editBtn.onclick = () => editProfileModal.style.display = "flex";
      closeBtn.onclick = () => editProfileModal.style.display = "none";

      window.onclick = (e) => {
        if (e.target === editProfileModal) editProfileModal.style.display = "none";
        //if (e.target === modalPantry) modalPantry.style.display = "none";
      };
    });
    document.addEventListener("DOMContentLoaded", function () {
      const openPantryButtons = document.querySelectorAll(".openPantryBtn");
      const modalPantry = document.getElementById("modalPantry");
      const closePantryBtn = document.getElementById("closePantryBtn");
      const addItemBtn = document.getElementById("btnAddItem");
      const pantryForm = document.getElementById("pantryForm");

      // --- OPEN PANTRY MODAL ---
      openPantryButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          modalPantry.classList.add("open");
          modalPantry.setAttribute("aria-hidden", "false");
          setTimeout(() => closePantryBtn.focus(), 100);
        });
      });

      // --- CLOSE MODAL HANDLERS ---
      closePantryBtn.addEventListener("click", () => {
        modalPantry.classList.remove("open");
        modalPantry.setAttribute("aria-hidden", "true");
        document.activeElement.blur();
      });

      window.addEventListener("click", e => {
        if (e.target === modalPantry) {
          modalPantry.classList.remove("open");
          modalPantry.setAttribute("aria-hidden", "true");
        }
      });


      // --- ADD ITEM BUTTON HANDLER ---
      if (addItemBtn && pantryForm) {
        addItemBtn.addEventListener("click", () => {
          pantryForm.reset();
          pantryForm.action = "/pantry/add/"; // ‚úÖ URL for adding item
          pantryForm.querySelector("button[type='submit']").textContent = "Add Item";

          const errors = pantryForm.querySelectorAll(".errorlist");
          errors.forEach(err => err.remove());

          pantryForm.scrollIntoView({ behavior: "smooth", block: "start" });
          const firstInput = pantryForm.querySelector("input, select, textarea");
          if (firstInput) firstInput.focus();
        });
      }

      // --- EDIT ITEM BUTTON HANDLER ---
      document.querySelectorAll(".editPantryBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const itemId = btn.dataset.id;
          const name = btn.dataset.name;
          const qty = btn.dataset.qty;
          const unit = btn.dataset.unit;
          const category = btn.dataset.category;
          const expire = btn.dataset.expire;

          pantryForm.reset();
          pantryForm.action = `/pantry/edit/${itemId}/`; // ‚úÖ edit endpoint
          pantryForm.querySelector("button[type='submit']").textContent = "Update Item";

          pantryForm.querySelector("[name='ingredient_name']").value = name;
          pantryForm.querySelector("[name='qty']").value = qty;
          pantryForm.querySelector("[name='unit']").value = unit;
          pantryForm.querySelector("[name='category']").value = category;
          pantryForm.querySelector("[name='expire_date']").value = expire;

          modalPantry.classList.add("open");
          modalPantry.setAttribute("aria-hidden", "false");
        });
      });

      // --- DELETE ITEM BUTTON HANDLER ---
      document.querySelectorAll(".deletePantryBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const itemId = btn.dataset.id;
          const confirmed = confirm("Are you sure you want to delete this item?");
          if (confirmed) {
            fetch(`/pantry/delete/${itemId}/`, {
              method: "POST",
              headers: {
                "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
              },
            })
              .then(res => {
                if (res.ok) location.reload();
                else alert("Error deleting item");
              })
              .catch(() => alert("Network error deleting item"));
          }
        });
      });
    });

    document.addEventListener("DOMContentLoaded", function() {
      const triggers = document.querySelectorAll(".GenerateMealBtn"); // all buttons/articles with this class
      const modalGenerate = document.getElementById("modalGenerate");
      const closeBtn = modalGenerate.querySelector(".modal-close");

      triggers.forEach(trigger => {
          trigger.addEventListener("click", () => {
              modalGenerate.classList.add("open");
              modalGenerate.setAttribute("aria-hidden", "false");
          });
      });

      closeBtn.addEventListener("click", () => {
          modalGenerate.classList.remove("open");
          modalGenerate.setAttribute("aria-hidden", "true");
      });

      window.addEventListener("click", (e) => {
          if (e.target === modalGenerate) {
              modalGenerate.classList.remove("open");
              modalGenerate.setAttribute("aria-hidden", "true");
          }
      });
    });

    // ‚úÖ Safer form handling: only attach listener if form exists
    document.addEventListener("DOMContentLoaded", function() {
      const form = document.getElementById("generateMealForm");
      if (!form) return;

      form.addEventListener("submit", function(e) {
        const selected = Array.from(document.querySelectorAll(".ingredient-checkbox:checked"))
                              .map(cb => cb.value);
        if (selected.length === 0) {
          e.preventDefault();
          alert("Please select at least one ingredient!");
          return;
        }
        document.getElementById("selectedIngredients").value = selected.join(",");
      });
    });
    const sidebarToggle = document.getElementById('sidebarToggle');
    const sidebar = document.querySelector('.sidebar');

    sidebarToggle.addEventListener('click', () => {
      sidebar.classList.toggle('open');
    });

    // --- Handle all 3 buttons with one form ---
    document.addEventListener("DOMContentLoaded", function() {
      const form = document.getElementById("generateMealForm");
      const actionType = document.getElementById("actionType");

      const btnMeal = document.getElementById("btnGenerateMeal");
      const btnDay = document.getElementById("btnGenerateDay");
      const btnWeek = document.getElementById("btnGenerateWeek");

      btnMeal.addEventListener("click", function() {
        actionType.name = "generate_meal";
        actionType.value = "1";
      });

      btnDay.addEventListener("click", function() {
        actionType.name = "generate_meal_day";
        actionType.value = "1";
      });

      btnWeek.addEventListener("click", function() {
        actionType.name = "generate_week";
        actionType.value = "1";
      });
    });
  
 
    document.addEventListener("DOMContentLoaded", function () {

      // --- Helper: Generate Nutrient Table Rows (supports nested objects) ---
      function generateNutrientRows(nutrients) {
          let rows = "";

          Object.entries(nutrients || {}).forEach(([key, value]) => {

              if (typeof value === "object" && value !== null) {
                  rows += `
                      <tr>
                          <td colspan="2" style="font-weight:bold;background:#f5f5f5;">
                              ${key}
                          </td>
                      </tr>
                  `;

                  Object.entries(value).forEach(([subKey, subValue]) => {
                      rows += `
                          <tr>
                              <td>${subKey}</td>
                              <td>${subValue}</td>
                          </tr>
                      `;
                  });

              } else {
                  rows += `
                      <tr>
                          <td>${key}</td>
                          <td>${value}</td>
                      </tr>
                  `;
              }
          });

          return rows;
      }


      // OPEN FAVORITES MODAL
      const btnOpenFavorites = document.getElementById("btnOpenFavorites");
      const modalFavorites = document.getElementById("modalFavorites");
      const closeFavoritesBtn = modalFavorites.querySelector(".modal-close");
      const favList = document.getElementById("favList");

      btnOpenFavorites.addEventListener("click", async () => {
          modalFavorites.style.display = "flex";
          modalFavorites.classList.add("open");
          modalFavorites.setAttribute("aria-hidden", "false");
          
          setTimeout(() => closeFavoritesBtn.focus(), 100); // allow focus
          await loadFavorites(); 
      });

      closeFavoritesBtn.addEventListener("click", () => {
          modalFavorites.classList.remove("open");
          modalFavorites.setAttribute("aria-hidden", "true");
          modalFavorites.style.display = "none";      // ‚úÖ hide
          btnOpenFavorites.focus();
          
      });

      window.addEventListener("click", e => {
        if (e.target === modalFavorites) {
          modalFavorites.classList.remove("open");
          modalFavorites.setAttribute("aria-hidden", "true");
          modalFavorites.style.display = "none"; 
        }
      });

      

      // LOAD FAVORITES INTO MODAL
      async function loadFavorites() {
        favList.innerHTML = "<p>Loading...</p>";

        const res = await fetch("{% url 'get_favorites' %}");
        const data = await res.json();

        favList.innerHTML = "";

        if (data.favorites.length === 0) {
            favList.innerHTML = "<p style='padding:10px;color:#666;'>No favorites yet ‚≠ê</p>";
            return;
        }

        data.favorites.forEach(fav => {

            const card = document.createElement("div");
            card.style.cssText =
                "border:1px solid #ccc; padding:12px; border-radius:8px;" +
                "margin-bottom:12px; background:white;";

            card.innerHTML = `
                <div style="display:flex; gap:12px; margin-bottom:10px;">
                    <img src="${fav.image}" 
                        style="width:80px;height:80px;border-radius:6px;object-fit:cover;">
                    <div style="flex:1;">
                        <h4 style="margin:0;font-size:18px;">${fav.name}</h4>
                        <p style="margin:0;color:#555;">${fav.calories} kcal</p>
                    </div>

                    <button class="unfavBtn" data-name="${fav.name}"
                            style="background:none;border:none;font-size:22px;color:red;cursor:pointer;">
                        ‚úñ
                    </button>
                </div>

                <hr style="margin:10px 0;">

                <p><b>Ingredients:</b></p>
                <ul style="padding-left:18px;margin-top:5px;">
                    ${Object.entries(fav.ingredients || {})
                        .map(([ing, qty]) => `<li>${ing} - ${qty}</li>`)
                        .join("")}
                </ul>

                <p style="margin-top:10px;"><b>Instructions:</b></p>
                <p style="white-space:pre-line; color:#444;">
                    ${fav.instructions || "No instructions available."}
                </p>

                <hr style="margin:10px 0;">

                <p><b>Main Nutrients:</b></p>

                <table border="1" cellpadding="6"
                    style="width:100%;border-collapse:collapse;margin-top:10px;background:#fafafa;">
                    <tr style="background:#e3f2fd;">
                        <th>Nutrient</th>
                        <th>Value</th>
                    </tr>

                    ${generateNutrientRows(fav.main_nutritents || {})}
                </table>
            `;

            favList.appendChild(card);
        });


        document.querySelectorAll(".unfavBtn").forEach(btn => {
            btn.addEventListener("click", async () => {
                await toggleFavorite(btn.dataset.name);
                await loadFavorites();
            });
        });
      }

      // ‚≠ê GLOBAL FUNCTION TO TOGGLE FAVORITE
      window.toggleFavorite = function (recipeName) {
        const formData = new FormData();
        formData.append("recipe_name", recipeName);
        formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");

        fetch("{% url 'toggle_favorite' %}", {
            method: "POST",
            body: formData
        })
        .then(res => res.json())
        .then(data => {
          console.log("Favorite toggle:", data.status);

          const btn = document.querySelector(`#favToggleBtn_${CSS.escape(recipeName)}`);
          if (btn) {
            if (data.status.includes("added")) {
                btn.innerHTML = "‚òÖ";
                btn.style.color = "gold";
                btn.dataset.favorited = "true";
            } else {
                btn.innerHTML = "‚òÜ";
                btn.style.color = "gray";
                btn.dataset.favorited = "false";
            }
          }
        });
      };
    });

    // Show toast when page loads if there are messages
    document.addEventListener('DOMContentLoaded', () => {
      const toast = document.getElementById('toast');
      if (toast && toast.querySelectorAll('p').length > 0) {
          toast.classList.add('show');

          // Hide after 3 seconds
          setTimeout(() => {
              toast.classList.remove('show');
          }, 10000);

          // Optional: click to dismiss immediately
          toast.addEventListener('click', () => {
              toast.classList.remove('show');
          });
      }
    });
    function scrollSubmitted(amount) {
      document.getElementById("submittedScroll").scrollLeft += amount;
    }
    function scrollCard(direction) {
      const container = document.getElementById("submittedScroll");

      // Width of one card (your card is ~260px + gap)
      const cardWidth = 300; // increase this value for faster jump!

      container.scrollBy({
        left: cardWidth * direction,
        behavior: "smooth"
      });
    }
    function openAIPopup() {
        document.getElementById("aiPopup").style.display = "flex";
    }

    function closeAIPopup() {
        document.getElementById("aiPopup").style.display = "none";
    }

    // Close when clicking outside
    document.addEventListener("click", function(e){
        let popup = document.getElementById("aiPopup");
        if (e.target === popup) {
            closeAIPopup();
        }
    });


    setTimeout(() => {
      document.querySelectorAll('.msg-alert').forEach(msg => {
          msg.style.transition = "opacity 0.5s";
          msg.style.opacity = "0";
          setTimeout(() => msg.remove(), 500);
      });
    }, 3000);

    function openPopup(id) {
        document.getElementById("recipeModal" + id).style.display = "flex";
    }

    function closePopup(id) {
        document.getElementById("recipeModal" + id).style.display = "none";
    }

    // Only close modals that have a data-close attribute or are meant to be closed by clicking outside
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal') && e.target.dataset.close !== "ignore") {
            e.target.style.display = 'none';
        }
    });


    //google translation 
    (function(){
      const TARGET_SECTION = document.getElementById('nutripop');

      let translateLoaded = false;

      window.toggleLangBox = function(){
        const el = document.getElementById("google_translate_element");
        el.style.display = (el.style.display === "none" || el.style.display === "") ? "block" : "none";
      };

      window.onGoogleTranslateLoad = function(){
        new google.translate.TranslateElement({
          pageLanguage: "en",
          includedLanguages: "af,sq,am,ar,hy,az,eu,be,bn,bg,ca,zh-CN,zh-TW,hr,cs,da,nl,en,et,fi,fr,gl,ka,de,el,gu,ht,he,hi,hu,is,id,it,ja,kn,kk,km,ko,lo,lv,lt,mg,ms,ml,mt,mr,mn,ne,no,pl,pt,pa,ro,ru,sr,si,sk,sl,es,sw,sv,ta,te,th,tr,uk,ur,vi,cy",
          layout: google.translate.TranslateElement.InlineLayout.HORIZONTAL
        }, "google_translate_element");
      };

      function wait(ms){ return new Promise(res => setTimeout(res, ms)); }

      function getVisibleText(maxChars = 120000){
        let walker = document.createTreeWalker(TARGET_SECTION, NodeFilter.SHOW_TEXT, {
          acceptNode: node => node.nodeValue.trim() ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT
        });
        let txt = "", node;
        while(node = walker.nextNode()){
          txt += node.nodeValue.trim() + " ";
          if(txt.length > maxChars) break;
        }
        return txt.replace(/\s+/g," ").trim();
      }

      function findVoiceForLang(code){
        const voices = speechSynthesis.getVoices();
        if(!voices.length) return null;
        const cand = [code, code.split('-')[0]];
        for(const c of cand){
          const v = voices.find(v => v.lang.toLowerCase().startsWith(c.toLowerCase()));
          if(v) return v;
        }
        return voices[0];
      }

      function ensureVoices(){
        return new Promise(res=>{
          let v = speechSynthesis.getVoices();
          if(v.length) return res(v);
          speechSynthesis.onvoiceschanged = ()=> res(speechSynthesis.getVoices());
        });
      }

      window.translateThenRead = async function(){
        const combo = document.querySelector(".goog-te-combo");
        if(!combo){
          alert("Please click Language and choose a language first.");
          return;
        }
        const selected = combo.value;
        if(!selected){
          alert("Choose a language first and press Read again.");
          return;
        }

        const original = getVisibleText(80000);
        combo.dispatchEvent(new Event("change"));
        await wait(350);

        let translated = getVisibleText(80000) || original;
        await ensureVoices();
        const voice = findVoiceForLang(selected);

        speechSynthesis.cancel();
        const pieces = translated.match(/[\s\S]{1,15000}/g);

        for(const part of pieces){
          const u = new SpeechSynthesisUtterance(part);
          u.lang = selected;
          if(voice) u.voice = voice;

          await new Promise(resolve=>{
            u.onend = resolve;
            speechSynthesis.speak(u);
          });

          // üî• Auto-stop if popup closed while narration is running
          if(TARGET_SECTION.style.display === "none" || !document.body.contains(TARGET_SECTION)){
            speechSynthesis.cancel();
            return;
          }
        }
      };

      document.getElementById("langBtn").addEventListener("click", function(){
        if(!translateLoaded){
          translateLoaded = true;
          document.getElementById("google_translate_element").style.display = "block";
          const s = document.createElement("script");
          s.src = "https://translate.google.com/translate_a/element.js?cb=onGoogleTranslateLoad";
          s.async = true;
          document.head.appendChild(s);
        }
      });

      document.getElementById("readBtn").addEventListener("click", function(){
        if(!translateLoaded){
          translateLoaded = true;
          const s = document.createElement("script");
          s.src = "https://translate.google.com/translate_a/element.js?cb=onGoogleTranslateLoad";
          s.async = true;
          document.head.appendChild(s);
          setTimeout(()=> alert("Translator loaded ‚Äî choose language then press Read again."), 500);
        }
      });

      // Auto stop if section removed / hidden
      const observer = new MutationObserver(()=>{
        if(TARGET_SECTION.style.display === "none" || !document.body.contains(TARGET_SECTION)){
          speechSynthesis.cancel();
        }
      });
      observer.observe(document.body, { attributes:true, subtree:true });

    })(); 

    document.addEventListener("DOMContentLoaded", function () {

      const btnGenerateDay = document.getElementById("btnSubmitGenerateDay");
      const formDay = document.getElementById("generateDayMealForm");
      const modalGenerateDay = document.getElementById("modalGenerateDay");
      const dayCloseBtn = modalGenerateDay.querySelector(".modal-close");
      const hiddenInput = document.getElementById("selectedIngredientsday");

      // Open modal
      document.querySelectorAll(".GenerateDayMealBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          modalGenerateDay.style.display = "flex";
          modalGenerateDay.setAttribute("aria-hidden", "false");
        });
      });

      // Close modal
      dayCloseBtn.addEventListener("click", () => {
        modalGenerateDay.style.display = "none";
        modalGenerateDay.setAttribute("aria-hidden", "true");
      });

      window.addEventListener("click", (e) => {
        if (e.target === modalGenerateDay) {
          modalGenerateDay.style.display = "none";
          modalGenerateDay.setAttribute("aria-hidden", "true");
        }
      });

      // Submit handler
      btnGenerateDay.addEventListener("click", (e) => {
        e.preventDefault();

        // ONLY check ingredients inside Day Meal form
        const selected = Array.from(formDay.querySelectorAll(".ingredient-checkbox:checked"))
                              .map(cb => cb.value);

        if (selected.length === 0) {
          alert("‚ö† Please select at least one ingredient!");
          return;
        }

        // Set hidden input
        hiddenInput.value = selected.join(",");
        console.log("Selected ingredient IDs (Day Meal):", hiddenInput.value);

        // Submit form
        formDay.submit();
      });

    });

    function closeDayPop() {
        fetch("{% url 'clear_day_plan' %}")   // calls your view
            .then(() => {
                document.getElementById("DayPop").style.display = "none";
            })
            .catch(err => console.log(err));
    }


    
    // Warning message box
    //const warningBox = document.querySelectorAll("warningBox");

    document.querySelectorAll('.ingredient-checkbox').forEach(function (checkbox) {
        checkbox.addEventListener('click', function (e) {
             const warningBox = checkbox.closest('.ingredients-grid').previousElementSibling;

            // Clear previous warning when selecting a new ingredient
            warningBox.style.display = "none";
            warningBox.innerHTML = "";

            const ingredientName = this.parentElement.textContent.trim();
            const ingredientId = this.dataset.id;  // Must be set in template: data-id="{{ ingredient.id }}"

            // Fetch nutrition JSON from json_script
            let nutrition = {};
            const nutritionScript = document.getElementById(`nutrition_${ingredientId}`);
            if (nutritionScript) {
                nutrition = JSON.parse(nutritionScript.textContent);
            }

            const calories = nutrition.Energy?.value || 0;
            const protein = nutrition.Protein?.value || 0;
            const carbs = nutrition["Carbohydrate, by difference"]?.value || 0;
            const fat = nutrition["Total lipid (fat)"]?.value || 0;
            const sodium = nutrition["Sodium, Na"]?.value || 0;
            const sugar = nutrition["Total Sugars"]?.value || 0;

            const dietaryPref = "{{ request.user.profile.dietary_pref }}";
            const goal = "{{ request.user.profile.goal }}";
            const allergies = "{{ request.user.profile.allergy_info|default:''|escapejs }}".toLowerCase()
                                .split(',')
                                .map(x => x.trim())
                                .filter(x => x.length > 0);

            // Helper to show warning message
            function showWarning(msg) {
                warningBox.innerHTML = msg;
                warningBox.style.display = "block";
                e.preventDefault();
                checkbox.checked = false;
            }

            /** 1Ô∏è‚É£ ALLERGY CHECK **/
            const ingredientLower = ingredientName.toLowerCase().trim();
            if (allergies.some(allergy => ingredientLower.includes(allergy))) {
                return showWarning(`‚ö†Ô∏è <b>${ingredientName}</b> is in your allergy list. Please remove it.`);
            }

            /** 2Ô∏è‚É£ DIETARY PREFERENCE CHECKS **/
            if (dietaryPref === "Vegan" && nutrition.Cholesterol?.value > 0) {
                return showWarning(`‚ö†Ô∏è <b>${ingredientName}</b> is animal-based. Not allowed in Vegan diet.`);
            }

            if (dietaryPref === "Vegetarian" && nutrition.Cholesterol?.value > 0) {
                return showWarning(`‚ö†Ô∏è <b>${ingredientName}</b> is not vegetarian.`);
            }

            if (dietaryPref === "Keto" && carbs > 20) {
                return showWarning(`‚ö†Ô∏è <b>${ingredientName}</b> has ${carbs}g carbs ‚Äî too high for Keto.`);
            }

            if (dietaryPref === "Low-Fat" && fat > 10) {
                return showWarning(`‚ö†Ô∏è <b>${ingredientName}</b> has ${fat}g fat ‚Äî not suitable for Low-Fat diet.`);
            }

            if (dietaryPref === "Low-Carb" && carbs > 30) {
                return showWarning(`‚ö†Ô∏è <b>${ingredientName}</b> has ${carbs}g carbs ‚Äî not suitable for Low-Carb diet.`);
            }

            if (dietaryPref === "Low-Sodium" && sodium > 500) {
                return showWarning(`‚ö†Ô∏è <b>${ingredientName}</b> has ${sodium} mg sodium ‚Äî not allowed in Low-Sodium diet.`);
            }

            if (dietaryPref === "Nut-Free" && ingredientName.toLowerCase().includes("nut")) {
                return showWarning(`‚ö†Ô∏è <b>${ingredientName}</b> contains nuts ‚Äî not safe for you.`);
            }

            /** 3Ô∏è‚É£ GOAL CHECKS **/
            if (goal === "Weight Loss" && calories > 350) {
                return showWarning(`‚ö†Ô∏è <b>${ingredientName}</b> has ${calories} kcal ‚Äî not suitable for Weight Loss.`);
            }

            if (goal === "Weight Gain" && protein < 5) {
                return showWarning(`‚ö†Ô∏è <b>${ingredientName}</b> is low in protein ‚Äî not useful for Weight Gain.`);
            }

            if (goal === "Maintenance" && sugar > 60) {
                return showWarning(`‚ö†Ô∏è <b>${ingredientName}</b> contains ${sugar}g sugar ‚Äî avoid excess sugar.`);
            }
        });
    });

    // ‚ùå Prevent form submission if warning exists
    document.querySelector("form").addEventListener("submit", function (e) {
        if (warningBox.style.display === "block") {
            e.preventDefault();
            warningBox.innerHTML += "<br>‚ö†Ô∏è Remove restricted ingredients before submitting.";
        }
    });

    
    document.addEventListener("DOMContentLoaded", function () {
        const openDayFavButton = document.getElementById("openDayFavBtn");
        const modalDayFavorites = document.getElementById("modalDayFavorites");
        const closeDayFavBtn = document.getElementById("closeDayFavBtn");

        if (!openDayFavButton || !modalDayFavorites || !closeDayFavBtn) {
            console.error("‚ùå Missing Day Favorites elements.");
            return;
        }

        // OPEN Day Favorites modal
        openDayFavButton.addEventListener("click", () => {
            modalDayFavorites.style.display = "flex";
            modalDayFavorites.setAttribute("aria-hidden", "false");
            modalDayFavorites.classList.add("open");
        });

        // CLOSE Day Favorites modal
        closeDayFavBtn.addEventListener("click", () => {
            modalDayFavorites.style.display = "none";
            modalDayFavorites.setAttribute("aria-hidden", "true");
            modalDayFavorites.classList.remove("open");
        });

        // Click outside to close (only Day Favorites)
        window.addEventListener("click", (e) => {
            if (e.target === modalDayFavorites) {
                modalDayFavorites.style.display = "none";
                modalDayFavorites.setAttribute("aria-hidden", "true");
                modalDayFavorites.classList.remove("open");
            }
        });
    });




   
    



  </script>

    
    
</body>
</html>